<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="test-title">B2 Test: Завантаження...</title>
    <meta
      http-equiv="Cache-Control"
      content="no-store, no-cache, must-revalidate, max-age=0"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      }
      /* Стиль для відключення вибору тексту для кращої симуляції тесту */
      .noselect {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
      import {
        getFirestore,
        setLogLevel,
        doc,
        getDoc,
        enableIndexedDbPersistence,
        initializeFirestore,
        persistentLocalCache,
      } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

      // Глобальні змінні, доступні для main.js
      window.db = null;
      window.userId = null;
      window.userRole = "user"; // За замовчуванням
      window.isAuthReady = false;

      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const firebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : {
              apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
              authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
              projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
              storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
              messagingSenderId: import.meta.env
                .VITE_FIREBASE_MESSAGING_SENDER_ID,
              appId: import.meta.env.VITE_FIREBASE_APP_ID,
              measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID,
            };

      const initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      // Ініціалізація та Аутентифікація
      async function initializeFirebase() {
        try {
          if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
            console.error(
              "Firebase config is missing. Using local storage fallback."
            );
            return; // Вихід, якщо конфігурації немає
          }

          const app = initializeApp(firebaseConfig);
          // Ініціалізація Firestore з кешуванням
          window.db = initializeFirestore(app, {
            localCache: persistentLocalCache(/*{size: CACHE_SIZE_UNLIMITED}*/),
          });

          window.auth = getAuth(app);
          setLogLevel("Debug");

          // Слухач зміни стану аутентифікації
          onAuthStateChanged(window.auth, async (user) => {
            if (user) {
              window.userId = user.uid;
              const userDocRef = doc(window.db, "users", user.uid);
              const userDoc = await getDoc(userDocRef);
              if (userDoc.exists()) {
                const role = userDoc.data().role;
                if (role === "admin" || role === "test") {
                  window.userRole = role;
                }
              }
              window.isAuthReady = true;
              console.log(
                "Firebase Auth Ready. User ID:",
                window.userId,
                "Role:",
                window.userRole
              );
              // Створення глобальної події готовності, яку можуть слухати інші скрипти
              window.dispatchEvent(new CustomEvent("firestoreReady"));
            } else {
              window.location.href = "login.html";
            }
          });
        } catch (error) {
          console.error("Error initializing Firebase:", error);
        }
      }

      initializeFirebase();
    </script>
  </head>
  <body
    class="bg-gray-50 min-h-screen flex flex-col noselect"
    autocomplete="off"
  >
    <header class="bg-white shadow-lg p-4 sticky top-0 z-20">
      <div
        class="container mx-auto max-w-4xl flex justify-between items-center"
      >
        <h1 class="text-xl font-bold text-gray-800">
          <a
            href="index.html"
            class="hover:text-blue-600 transition duration-150"
            >B2 Test Trainer</a
          >
        </h1>
        <div class="flex items-center space-x-4">
          <div
            id="timer"
            class="text-xl font-mono font-extrabold text-red-600 bg-red-100 p-2 rounded-lg shadow"
          >
            --:--
          </div>
          <div
            id="block-timer"
            class="text-sm font-mono text-blue-600 bg-blue-100 p-2 rounded-lg shadow"
          >
            Block: --:-- / --:--
          </div>
          <div
            id="teil-timer"
            class="text-sm font-mono text-green-600 bg-green-100 p-2 rounded-lg shadow"
          >
            Teil: --:--
          </div>
          <div
            id="exercise-timer"
            class="text-sm font-mono text-yellow-600 bg-yellow-100 p-2 rounded-lg shadow"
          >
            Exercise: --:--
          </div>
        </div>
      </div>
    </header>

    <div
      id="test-user-banner"
      class="hidden bg-red-100 border-t-4 border-b-4 border-red-500 text-red-700 px-4 py-3 text-center"
      role="alert"
    >
      Dies ist der Testmodus. Nur ein Test ist verfügbar. Registrieren Sie sich!
    </div>

    <main class="flex-grow container mx-auto max-w-4xl p-4 md:p-8 pb-32">
      <h2
        id="current-test-title"
        class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2"
      >
        Тест
      </h2>

      <div
        id="progress-indicator"
        class="w-full bg-gray-200 rounded-full h-2.5 mb-6"
      >
        <div class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
      </div>

      <section
        id="stimulus-container"
        class="bg-white p-6 rounded-xl shadow-lg mb-8"
      >
        <h3 class="text-xl font-bold text-blue-700 mb-4 border-b pb-2">
          Тексти / Медіа
        </h3>
        <div id="stimulus-text" class="space-y-4"></div>
      </section>

      <section id="questions-container" class="space-y-8">
        <div class="text-center text-gray-500 p-10">Завантаження тесту...</div>
      </section>
    </main>

    <footer class="bg-white shadow-inner p-4 sticky bottom-0 z-10">
      <div class="container mx-auto max-w-4xl">
        <div class="flex justify-between items-center">
          <button
            id="prev-btn"
            class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150 disabled:opacity-50"
            disabled
          >
            ← Zurück
          </button>

          <button
            id="finish-btn"
            class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition duration-300 disabled:opacity-50"
          >
            Test beenden
          </button>

          <button
            id="next-btn"
            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 disabled:opacity-50"
          >
            Weiter →
          </button>
        </div>
      </div>
    </footer>
    <script>
      function showTestUserBanner() {
        if (window.userRole === "test") {
          document
            .getElementById("test-user-banner")
            .classList.remove("hidden");
        }
      }
      if (window.isAuthReady) {
        showTestUserBanner();
      } else {
        window.addEventListener("firestoreReady", showTestUserBanner);
      }
    </script>
    <script type="module" src="src/js/main.js"></script>
  </body>
</html>
